import{c as a,o,a as t,_ as fe,u as pe,C as ve,b as me,r as d,d as G,D as ge,P as ye,e as xe,f as l,g as u,j as c,t as f,w as U,i as O,I as he,F as B,h as _e,S as J,y as Q,A as ee,H as be,B as k,N as p,X as we,p as D,m as V}from"./main-BgCzwRDh.js";import{d as I}from"./dayjs.min-iy57P9mS.js";import{r as ke}from"./ArrowLeftIcon-BQ1kV-Kh.js";import{r as Ce}from"./PhoneIcon-rmjUJ_DX.js";import{r as A}from"./CheckIcon-C5gVB0J1.js";import"./_commonjsHelpers-Cpj98o6Y.js";function te(T,g){return o(),a("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15 8.25H9m6 3H9m3 6-3-3h1.5a3 3 0 1 0 0-6M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})])}function $e(T,g){return o(),a("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z"})])}function Me(T,g){return o(),a("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"})])}const je={class:"conversation-page"},Se={class:"conversation-header"},Oe={class:"flex items-center gap-3 px-4 py-3"},Be={key:0,class:"flex items-center gap-3 flex-1 min-w-0"},De={class:"relative"},Ie=["src","alt"],Te={class:"min-w-0 flex-1"},ze={class:"font-semibold text-gray-900 truncate"},Fe={class:"flex items-center gap-1"},Ue=["href"],Ve={class:"relative"},Ae={key:0,class:"absolute right-0 top-full mt-1 w-48 bg-white rounded-xl shadow-lg border z-50"},He={key:0,class:"px-4 pb-3"},Le=["src","alt"],Ne={class:"flex-1 min-w-0"},Ye={class:"font-medium text-gray-900 truncate text-sm"},Ze={class:"text-primary-600 font-bold text-sm"},Ee={key:0,class:"flex justify-center py-8"},Re={class:"flex justify-center mb-4"},Ke={class:"px-3 py-1 bg-gray-200 rounded-full text-xs text-gray-600"},Pe={key:0,class:"mb-2"},We={class:"flex items-center gap-2 mb-1"},Xe={class:"text-2xl font-bold"},qe={key:0,class:"flex gap-2 mt-3"},Ge=["onClick"],Je=["onClick"],Qe={class:"whitespace-pre-wrap break-words"},et={key:0,class:"flex items-center"},tt={key:0,class:"text-center py-8 text-gray-500"},st={class:"conversation-input"},rt={class:"flex-1"},ot=["onKeydown"],at=["disabled"],nt={key:1,class:"fixed inset-0 z-50 flex items-end sm:items-center justify-center"},lt={class:"relative bg-white w-full sm:max-w-sm sm:rounded-xl rounded-t-2xl p-6 pb-safe"},it={key:0,class:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg mb-4"},dt=["src"],ut={class:"min-w-0 flex-1"},ct={class:"font-medium text-sm truncate"},ft={class:"text-primary-600 font-bold"},pt={class:"relative mb-4"},vt={class:"flex gap-3"},mt=["disabled"],gt={__name:"Conversation",setup(T){const g=pe(),z=ve(),se=me(),H=d(!0),$=d(!1),n=d(null),i=d([]),x=d(""),v=d(!1),C=d(!1),h=d(""),M=d(null),F=d(null),y=G(()=>{var r;return(r=se.user)==null?void 0:r.id}),w=G(()=>n.value?n.value.buyer_id===y.value?n.value.seller:n.value.buyer:null),re=r=>I(r).format("h:mm A"),oe=r=>{if(!r)return"";const e=I(r);return e.isSame(I(),"day")?"Today":e.isSame(I().subtract(1,"day"),"day")?"Yesterday":e.format("MMM D, YYYY")},ae=r=>{const e=r.target;e.style.height="auto",e.style.height=Math.min(e.scrollHeight,120)+"px"},ne=()=>{F.value&&(F.value.style.height="auto")},j=()=>{we(()=>{M.value&&(M.value.scrollTop=M.value.scrollHeight)})},le=async()=>{try{const r=await k.get(`/conversations/${g.params.uuid}`);n.value=r.data.data.conversation,i.value=r.data.data.messages.data||[],j()}catch{p.error("Failed to load conversation"),z.push("/messages")}finally{H.value=!1}},L=async()=>{if(!x.value.trim()||$.value)return;$.value=!0;const r=x.value;x.value="",ne();const e="temp-"+Date.now(),m={id:e,body:r,sender_id:y.value,created_at:new Date().toISOString(),is_read:!1,type:"text"};i.value.push(m),j(),$.value=!1;try{const _=await k.post(`/conversations/${g.params.uuid}/messages`,{message:r,type:"text"}),b=i.value.findIndex(S=>S.id===e);b!==-1&&(i.value[b]=_.data.data)}catch{i.value=i.value.filter(b=>b.id!==e),x.value=r,p.error("Failed to send message")}},ie=async()=>{if(h.value)try{const r=await k.post(`/conversations/${g.params.uuid}/messages`,{message:`I'd like to offer ₹${h.value}`,type:"offer",offer_amount:h.value});i.value.push(r.data.data),C.value=!1,h.value="",j(),p.success("Offer sent!")}catch{p.error("Failed to send offer")}},N=async(r,e)=>{try{await k.post(`/messages/${r}/offer-response`,{action:e});const m=i.value.find(_=>_.id===r);m&&(m.offer_status=e==="accept"?"accepted":"rejected"),p.success(`Offer ${e}ed`)}catch{p.error("Failed to respond to offer")}},de=async()=>{v.value=!1;try{await k.post(`/conversations/${g.params.uuid}/block`),p.success("User blocked"),z.push("/messages")}catch{p.error("Failed to block user")}},ue=async()=>{v.value=!1;try{await k.delete(`/conversations/${g.params.uuid}`),p.success("Conversation deleted"),z.push("/messages")}catch{p.error("Failed to delete conversation")}},Y=()=>{j()};return ge(()=>{le(),window.addEventListener("resize",Y)}),ye(()=>{window.removeEventListener("resize",Y)}),(r,e)=>{var _,b,S,Z,E,R,K,P,W,X;const m=xe("router-link");return o(),a("div",je,[t("header",Se,[t("div",Oe,[t("button",{onClick:e[0]||(e[0]=s=>r.$router.push("/messages")),class:"p-2 -ml-2 hover:bg-gray-100 rounded-full"},[u(c(ke),{class:"w-5 h-5 text-gray-600"})]),n.value?(o(),a("div",Be,[t("div",De,[t("img",{src:((_=w.value)==null?void 0:_.avatar_url)||"/images/default-avatar.png",alt:(b=w.value)==null?void 0:b.name,class:"w-10 h-10 rounded-full object-cover bg-gray-200"},null,8,Ie),e[10]||(e[10]=t("span",{class:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"},null,-1))]),t("div",Te,[t("h1",ze,f((S=w.value)==null?void 0:S.name),1),e[11]||(e[11]=t("p",{class:"text-xs text-green-600"},"Online",-1))])])):l("",!0),t("div",Fe,[(Z=w.value)!=null&&Z.phone?(o(),a("a",{key:0,href:`tel:${w.value.phone}`,class:"p-2 hover:bg-gray-100 rounded-full"},[u(c(Ce),{class:"w-5 h-5 text-gray-600"})],8,Ue)):l("",!0),t("div",Ve,[t("button",{onClick:e[1]||(e[1]=s=>v.value=!v.value),class:"p-2 hover:bg-gray-100 rounded-full"},[u(c($e),{class:"w-5 h-5 text-gray-600"})]),v.value?(o(),a("div",Ae,[u(m,{to:`/listing/${(R=(E=n.value)==null?void 0:E.listing)==null?void 0:R.slug}`,class:"block px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-t-xl",onClick:e[2]||(e[2]=s=>v.value=!1)},{default:U(()=>[...e[12]||(e[12]=[O(" View Listing ",-1)])]),_:1},8,["to"]),u(m,{to:`/user/${(K=w.value)==null?void 0:K.id}`,class:"block px-4 py-3 text-gray-700 hover:bg-gray-50",onClick:e[3]||(e[3]=s=>v.value=!1)},{default:U(()=>[...e[13]||(e[13]=[O(" View Profile ",-1)])]),_:1},8,["to"]),t("button",{onClick:de,class:"w-full px-4 py-3 text-left text-red-600 hover:bg-red-50"}," Block User "),t("button",{onClick:ue,class:"w-full px-4 py-3 text-left text-red-600 hover:bg-red-50 rounded-b-xl"}," Delete Chat ")])):l("",!0)])])]),(P=n.value)!=null&&P.listing?(o(),a("div",He,[u(m,{to:`/listing/${n.value.listing.slug}`,class:"flex items-center gap-3 p-2 bg-gray-50 rounded-xl hover:bg-gray-100 transition"},{default:U(()=>[t("img",{src:n.value.listing.primary_image_url,alt:n.value.listing.title,class:"w-12 h-12 rounded-lg object-cover bg-gray-200"},null,8,Le),t("div",Ne,[t("p",Ye,f(n.value.listing.title),1),t("p",Ze,f(n.value.listing.formatted_price||"₹"+n.value.listing.price),1)]),u(c(he),{class:"w-5 h-5 text-gray-400 flex-shrink-0"})]),_:1},8,["to"])])):l("",!0)]),v.value?(o(),a("div",{key:0,class:"fixed inset-0 z-40",onClick:e[4]||(e[4]=s=>v.value=!1)})):l("",!0),t("div",{ref_key:"messagesContainer",ref:M,class:"messages-area"},[H.value?(o(),a("div",Ee,[...e[14]||(e[14]=[t("div",{class:"w-8 h-8 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin"},null,-1)])])):(o(),a(B,{key:1},[t("div",Re,[t("span",Ke,f(oe((W=i.value[0])==null?void 0:W.created_at)),1)]),(o(!0),a(B,null,_e(i.value,s=>{var q;return o(),a("div",{key:s.id,class:D(["flex mb-3",s.sender_id===y.value?"justify-end":"justify-start"])},[t("div",{class:D(["max-w-[80%] rounded-2xl px-4 py-2 shadow-sm transition-opacity",[s.sender_id===y.value?"bg-primary-600 text-white rounded-br-sm":"bg-white text-gray-900 rounded-bl-sm",String(s.id).startsWith("temp-")?"opacity-70":""]])},[s.type==="offer"?(o(),a("div",Pe,[t("div",We,[u(c(te),{class:"w-4 h-4"}),e[15]||(e[15]=t("span",{class:"text-sm opacity-80"},"Offer",-1))]),t("p",Xe,"₹"+f((q=s.offer_amount)==null?void 0:q.toLocaleString()),1),s.offer_status==="pending"&&s.sender_id!==y.value?(o(),a("div",qe,[t("button",{onClick:ce=>N(s.id,"accept"),class:"flex-1 px-3 py-2 bg-green-500 text-white rounded-lg text-sm font-medium"}," Accept ",8,Ge),t("button",{onClick:ce=>N(s.id,"reject"),class:"flex-1 px-3 py-2 bg-white/20 text-white rounded-lg text-sm font-medium"}," Decline ",8,Je)])):s.offer_status!=="pending"?(o(),a("p",{key:1,class:D(["text-sm mt-2 font-medium",s.sender_id===y.value?s.offer_status==="accepted"?"text-green-200":"text-red-200":s.offer_status==="accepted"?"text-green-600":"text-red-600"])},f(s.offer_status==="accepted"?"Accepted":"Declined"),3)):l("",!0)])):l("",!0),t("p",Qe,f(s.body),1),t("p",{class:D(["text-[10px] mt-1 flex items-center gap-1",s.sender_id===y.value?"text-primary-200 justify-end":"text-gray-400"])},[String(s.id).startsWith("temp-")?(o(),a(B,{key:0},[O(" Sending... ")],64)):(o(),a(B,{key:1},[O(f(re(s.created_at))+" ",1),s.sender_id===y.value?(o(),a("span",et,[s.is_read?(o(),V(c(A),{key:0,class:"w-3 h-3"})):l("",!0),s.is_read?(o(),V(c(A),{key:1,class:"w-3 h-3 -ml-1"})):(o(),V(c(A),{key:2,class:"w-3 h-3"}))])):l("",!0)],64))],2)],2)],2)}),128)),i.value.length===0?(o(),a("div",tt,[...e[16]||(e[16]=[t("p",null,"No messages yet. Say hello!",-1)])])):l("",!0)],64))],512),t("div",st,[t("form",{onSubmit:J(L,["prevent"]),class:"flex items-center gap-2"},[t("button",{type:"button",onClick:e[5]||(e[5]=s=>C.value=!0),class:"w-11 h-11 text-primary-600 hover:bg-primary-50 rounded-full flex-shrink-0 flex items-center justify-center",title:"Make an offer"},[u(c(te),{class:"w-6 h-6"})]),t("div",rt,[Q(t("textarea",{ref_key:"messageInput",ref:F,"onUpdate:modelValue":e[6]||(e[6]=s=>x.value=s),placeholder:"Type a message...",class:"w-full px-4 py-2.5 bg-gray-100 rounded-2xl resize-none focus:outline-none focus:ring-2 focus:ring-primary-500 leading-normal",rows:"1",onInput:ae,onKeydown:be(J(L,["exact","prevent"]),["enter"]),style:{"max-height":"120px"}},null,40,ot),[[ee,x.value]])]),t("button",{type:"submit",disabled:!x.value.trim()||$.value,class:"w-11 h-11 bg-primary-600 text-white rounded-full flex-shrink-0 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-primary-700 transition flex items-center justify-center"},[u(c(Me),{class:"w-5 h-5"})],8,at)],32)]),C.value?(o(),a("div",nt,[t("div",{class:"absolute inset-0 bg-black/50",onClick:e[7]||(e[7]=s=>C.value=!1)}),t("div",lt,[e[18]||(e[18]=t("h3",{class:"text-lg font-semibold mb-4"},"Make an Offer",-1)),(X=n.value)!=null&&X.listing?(o(),a("div",it,[t("img",{src:n.value.listing.primary_image_url,class:"w-12 h-12 rounded-lg object-cover"},null,8,dt),t("div",ut,[t("p",ct,f(n.value.listing.title),1),t("p",ft,f(n.value.listing.formatted_price||"₹"+n.value.listing.price),1)])])):l("",!0),t("div",pt,[e[17]||(e[17]=t("span",{class:"absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 text-lg"},"₹",-1)),Q(t("input",{"onUpdate:modelValue":e[8]||(e[8]=s=>h.value=s),type:"number",min:"1",class:"w-full pl-10 pr-4 py-3 bg-gray-100 rounded-xl text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-primary-500",placeholder:"Enter your offer"},null,512),[[ee,h.value]])]),t("div",vt,[t("button",{onClick:e[9]||(e[9]=s=>C.value=!1),class:"flex-1 py-3 border border-gray-300 rounded-xl font-medium"}," Cancel "),t("button",{onClick:ie,class:"flex-1 py-3 bg-primary-600 text-white rounded-xl font-medium disabled:opacity-50",disabled:!h.value}," Send Offer ",8,mt)])])])):l("",!0)])}}},kt=fe(gt,[["__scopeId","data-v-17a596f7"]]);export{kt as default};
