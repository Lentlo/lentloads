import{c as n,o,a as e,_ as ce,u as ve,C as fe,b as pe,r as d,d as D,D as me,e as he,f as u,g as r,j as i,t as c,w as O,I as _e,S as P,F as R,h as ge,s as ke,y as E,A as X,H as ye,m as q,B as b,N as v,X as we,p as G}from"./main-Bp0sOZm1.js";import{d as F}from"./dayjs.min-iy57P9mS.js";import{r as be}from"./ArrowLeftIcon-FT3hJBTj.js";import{r as $e}from"./PhoneIcon-BM0D3yGj.js";import{r as Ce}from"./EyeIcon-CTF7UDxJ.js";import{r as xe}from"./UserIcon-kBZ5NNlq.js";import{r as Me}from"./TrashIcon-72vxQmis.js";import{r as J}from"./CheckIcon-CxZ1muaY.js";import"./_commonjsHelpers-Cpj98o6Y.js";function Q(C,f){return o(),n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15 8.25H9m6 3H9m3 6-3-3h1.5a3 3 0 1 0 0-6M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})])}function Ae(C,f){return o(),n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z"})])}function Be(C,f){return o(),n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M18.364 18.364A9 9 0 0 0 5.636 5.636m12.728 12.728A9 9 0 0 1 5.636 5.636m12.728 12.728L5.636 5.636"})])}function Fe(C,f){return o(),n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"})])}const Se={class:"chat-page"},De={class:"chat-header"},Oe={class:"header-content"},Ue={class:"avatar-ring"},je=["src"],Te={class:"user-details"},Ve={class:"header-actions"},Ie=["href"],Le={key:0,class:"product-strip"},Ye=["src"],He={class:"product-info"},Ze={class:"product-name"},Ne={class:"product-price"},ze={class:"product-arrow"},Ke={key:0,class:"loading"},Pe={key:0,class:"date-chip"},Re={class:"msg-bubble"},Ee={key:0,class:"offer-content"},Xe={class:"offer-icon"},qe={class:"offer-amount"},Ge={key:0,class:"offer-actions"},Je=["onClick"],Qe=["onClick"],We={class:"msg-text"},es={class:"msg-meta"},ss={class:"msg-time"},ts={key:0,class:"msg-status"},as={key:1,class:"empty-chat"},os={class:"empty-icon"},ns={class:"input-area"},ls={class:"input-wrapper"},rs=["onKeydown"],is=["disabled"],us={key:0,class:"send-spinner"},ds={key:1,class:"modal-overlay"},cs={class:"modal-sheet"},vs={key:0,class:"modal-listing"},fs=["src"],ps={class:"listing-title"},ms={class:"listing-price"},hs={class:"offer-field"},_s={class:"modal-actions"},gs=["disabled"],ks={__name:"Conversation",setup(C){const f=ve(),x=fe(),W=pe(),U=d(!0),h=d(!1),l=d(null),p=d([]),_=d(""),w=d(!1),$=d(!1),g=d(""),M=d(null),k=d(null),A=D(()=>{var t;return(t=W.user)==null?void 0:t.id}),m=D(()=>l.value?l.value.buyer_id===A.value?l.value.seller:l.value.buyer:null),ee=D(()=>{var s;const t=((s=m.value)==null?void 0:s.name)||"U";return`https://ui-avatars.com/api/?name=${encodeURIComponent(t)}&background=7c3aed&color=fff&size=100&bold=true`}),se=t=>F(t).format("h:mm A"),te=t=>{if(!t)return"";const s=F(t);return s.isSame(F(),"day")?"Today":s.isSame(F().subtract(1,"day"),"day")?"Yesterday":s.format("MMM D, YYYY")},S=()=>{we(()=>{M.value&&(M.value.scrollTop=M.value.scrollHeight)})},ae=()=>{k.value&&(k.value.style.height="auto",k.value.style.height=Math.min(k.value.scrollHeight,100)+"px")},oe=()=>{w.value=!w.value},ne=()=>{var t;(t=m.value)!=null&&t.id&&x.push(`/user/${m.value.id}`)},le=async()=>{try{const t=await b.get(`/conversations/${f.params.uuid}`);l.value=t.data.data.conversation,p.value=t.data.data.messages.data||[],S()}catch{v.error("Failed to load chat"),x.push("/messages")}finally{U.value=!1}},j=async()=>{if(!_.value.trim()||h.value)return;h.value=!0;const t=_.value;_.value="",k.value&&(k.value.style.height="auto");try{const s=await b.post(`/conversations/${f.params.uuid}/messages`,{message:t,type:"text"});p.value.push(s.data.data),S()}catch{_.value=t,v.error("Failed to send")}finally{h.value=!1}},re=async()=>{if(g.value){$.value=!1,h.value=!0;try{const t=await b.post(`/conversations/${f.params.uuid}/messages`,{message:`Offer: ₹${g.value}`,type:"offer",offer_amount:g.value});p.value.push(t.data.data),g.value="",S(),v.success("Offer sent")}catch{v.error("Failed to send offer")}finally{h.value=!1}}},T=async(t,s)=>{try{await b.post(`/messages/${t}/offer-response`,{action:s});const y=p.value.find(B=>B.id===t);y&&(y.offer_status=s==="accept"?"accepted":"rejected"),v.success(`Offer ${s}ed`)}catch{v.error("Failed")}},ie=async()=>{w.value=!1;try{await b.post(`/conversations/${f.params.uuid}/block`),v.success("User blocked"),x.push("/messages")}catch{v.error("Failed")}},ue=async()=>{w.value=!1;try{await b.delete(`/conversations/${f.params.uuid}`),v.success("Chat deleted"),x.push("/messages")}catch{v.error("Failed")}};return me(le),(t,s)=>{var B,V,I,L,Y,H,Z,N,z;const y=he("router-link");return o(),n("div",Se,[e("header",De,[s[10]||(s[10]=e("div",{class:"header-bg"},null,-1)),e("div",Oe,[e("button",{onClick:s[0]||(s[0]=a=>t.$router.push("/messages")),class:"back-btn"},[r(i(be),{class:"w-5 h-5"})]),l.value?(o(),n("div",{key:0,class:"user-section",onClick:ne},[e("div",Ue,[e("img",{src:((B=m.value)==null?void 0:B.avatar_url)||ee.value,class:"avatar"},null,8,je),s[8]||(s[8]=e("span",{class:"online-indicator"},null,-1))]),e("div",Te,[e("h1",null,c((V=m.value)==null?void 0:V.name),1),s[9]||(s[9]=e("div",{class:"status"},[e("span",{class:"status-dot"}),e("span",null,"Active now")],-1))])])):u("",!0),e("div",Ve,[(I=m.value)!=null&&I.phone?(o(),n("a",{key:0,href:`tel:${m.value.phone}`,class:"header-btn phone"},[r(i($e),{class:"w-5 h-5"})],8,Ie)):u("",!0),e("button",{onClick:oe,class:"header-btn menu"},[r(i(Ae),{class:"w-5 h-5"})])])]),(L=l.value)!=null&&L.listing?(o(),n("div",Le,[r(y,{to:`/listing/${l.value.listing.slug}`,class:"product-card"},{default:O(()=>[e("img",{src:l.value.listing.primary_image_url,class:"product-img"},null,8,Ye),e("div",He,[e("p",Ze,c(l.value.listing.title),1),e("p",Ne,c(l.value.listing.formatted_price||"₹"+l.value.listing.price),1)]),e("div",ze,[r(i(_e),{class:"w-4 h-4"})])]),_:1},8,["to"])])):u("",!0)]),w.value?(o(),n("div",{key:0,class:"menu-overlay",onClick:s[2]||(s[2]=a=>w.value=!1)},[e("div",{class:"dropdown-menu",onClick:s[1]||(s[1]=P(()=>{},["stop"]))},[r(y,{to:`/listing/${(H=(Y=l.value)==null?void 0:Y.listing)==null?void 0:H.slug}`,class:"menu-item"},{default:O(()=>[r(i(Ce),{class:"w-5 h-5"}),s[11]||(s[11]=e("span",null,"View Listing",-1))]),_:1},8,["to"]),r(y,{to:`/user/${(Z=m.value)==null?void 0:Z.id}`,class:"menu-item"},{default:O(()=>[r(i(xe),{class:"w-5 h-5"}),s[12]||(s[12]=e("span",null,"View Profile",-1))]),_:1},8,["to"]),e("button",{onClick:ie,class:"menu-item danger"},[r(i(Be),{class:"w-5 h-5"}),s[13]||(s[13]=e("span",null,"Block User",-1))]),e("button",{onClick:ue,class:"menu-item danger"},[r(i(Me),{class:"w-5 h-5"}),s[14]||(s[14]=e("span",null,"Delete Chat",-1))])])])):u("",!0),e("div",{ref_key:"messagesArea",ref:M,class:"messages-area"},[U.value?(o(),n("div",Ke,[...s[15]||(s[15]=[e("div",{class:"spinner"},null,-1),e("p",null,"Loading messages...",-1)])])):(o(),n(R,{key:1},[p.value.length?(o(),n("div",Pe,[e("span",null,c(te((N=p.value[0])==null?void 0:N.created_at)),1)])):u("",!0),(o(!0),n(R,null,ge(p.value,a=>{var K;return o(),n("div",{key:a.id,class:G(["msg-wrapper",a.sender_id===A.value?"sent":"received"])},[e("div",Re,[a.type==="offer"?(o(),n("div",Ee,[e("div",Xe,[r(i(Q),{class:"w-5 h-5"})]),s[16]||(s[16]=e("p",{class:"offer-label"},"Price Offer",-1)),e("p",qe,"₹"+c((K=a.offer_amount)==null?void 0:K.toLocaleString()),1),a.offer_status==="pending"&&a.sender_id!==A.value?(o(),n("div",Ge,[e("button",{onClick:de=>T(a.id,"accept"),class:"accept-btn"},"Accept",8,Je),e("button",{onClick:de=>T(a.id,"reject"),class:"decline-btn"},"Decline",8,Qe)])):a.offer_status!=="pending"?(o(),n("div",{key:1,class:G(["offer-badge",a.offer_status])},c(a.offer_status==="accepted"?"Accepted":"Declined"),3)):u("",!0)])):u("",!0),e("p",We,c(a.body),1),e("div",es,[e("span",ss,c(se(a.created_at)),1),a.sender_id===A.value?(o(),n("span",ts,[r(i(J),{class:"w-3.5 h-3.5"}),a.is_read?(o(),q(i(J),{key:0,class:"w-3.5 h-3.5 -ml-1.5"})):u("",!0)])):u("",!0)])])],2)}),128)),p.value.length?u("",!0):(o(),n("div",as,[e("div",os,[r(i(ke),{class:"w-12 h-12"})]),s[17]||(s[17]=e("h3",null,"Start the conversation",-1)),s[18]||(s[18]=e("p",null,"Send a message or make an offer",-1))]))],64))],512),e("div",ns,[e("button",{onClick:s[3]||(s[3]=a=>$.value=!0),class:"offer-trigger"},[r(i(Q),{class:"w-6 h-6"})]),e("div",ls,[E(e("textarea",{ref_key:"inputField",ref:k,"onUpdate:modelValue":s[4]||(s[4]=a=>_.value=a),placeholder:"Type your message...",rows:"1",onInput:ae,onKeydown:ye(P(j,["exact","prevent"]),["enter"])},null,40,rs),[[X,_.value]])]),e("button",{onClick:j,disabled:!_.value.trim()||h.value,class:"send-trigger"},[h.value?(o(),n("div",us)):(o(),q(i(Fe),{key:1,class:"w-5 h-5"}))],8,is)]),$.value?(o(),n("div",ds,[e("div",{class:"modal-backdrop",onClick:s[5]||(s[5]=a=>$.value=!1)}),e("div",cs,[s[20]||(s[20]=e("div",{class:"modal-handle"},null,-1)),s[21]||(s[21]=e("h3",null,"Make an Offer",-1)),(z=l.value)!=null&&z.listing?(o(),n("div",vs,[e("img",{src:l.value.listing.primary_image_url},null,8,fs),e("div",null,[e("p",ps,c(l.value.listing.title),1),e("p",ms,c(l.value.listing.formatted_price||"₹"+l.value.listing.price),1)])])):u("",!0),e("div",hs,[s[19]||(s[19]=e("span",{class:"currency"},"₹",-1)),E(e("input",{"onUpdate:modelValue":s[6]||(s[6]=a=>g.value=a),type:"number",placeholder:"Your offer"},null,512),[[X,g.value]])]),e("div",_s,[e("button",{onClick:s[7]||(s[7]=a=>$.value=!1),class:"btn-cancel"},"Cancel"),e("button",{onClick:re,disabled:!g.value,class:"btn-submit"},"Send Offer",8,gs)])])])):u("",!0)])}}},Fs=ce(ks,[["__scopeId","data-v-6e7aabb8"]]);export{Fs as default};
