import{c as l,o,a as e,_ as re,u as ie,C as ue,b as ce,r,d as z,D as de,e as ve,f as i,g as f,j as w,t as u,w as O,i as E,S as P,I as fe,F as R,h as pe,y as X,A as q,H as me,m as _e,B as b,N as c,X as he,p as ge}from"./main-DoU2-kww.js";import{d as B}from"./dayjs.min-iy57P9mS.js";import{r as ye}from"./ArrowLeftIcon-BYkWNGS8.js";import{r as ke}from"./PhoneIcon-HZBGOyoX.js";import"./_commonjsHelpers-Cpj98o6Y.js";function we(D,d){return o(),l("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15 8.25H9m6 3H9m3 6-3-3h1.5a3 3 0 1 0 0-6M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})])}function be(D,d){return o(),l("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z"})])}function Ce(D,d){return o(),l("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"})])}const xe={class:"conversation-page"},$e={class:"chat-header"},Me=["src"],Be={class:"user-text"},De={class:"header-actions"},Fe=["href"],Ae={key:1,class:"product-bar"},Oe=["src"],je={class:"product-text"},Se={class:"product-title"},Te={class:"product-price"},Ve={key:0,class:"loading"},Ne={key:0,class:"date-label"},Ue={class:"msg-bubble"},He={key:0,class:"offer-box"},Ie={class:"offer-price"},Ye={key:0,class:"offer-btns"},Ze=["onClick"],Le=["onClick"],Ke={key:1,class:"offer-result"},ze={class:"msg-text"},Ee={class:"msg-time"},Pe={key:1,class:"empty"},Re={class:"input-area"},Xe=["onKeydown"],qe=["disabled"],Ge={key:0,class:"btn-spinner"},Je={key:2,class:"modal"},Qe={class:"modal-box"},We={key:0,class:"modal-product"},es=["src"],ss={class:"price"},ts={class:"offer-input"},as={class:"modal-btns"},os=["disabled"],ls={__name:"Conversation",setup(D){const d=ie(),x=ue(),G=ce(),j=r(!0),p=r(!1),n=r(null),v=r([]),m=r(""),k=r(!1),C=r(!1),_=r(""),$=r(null),h=r(null),F=z(()=>{var t;return(t=G.user)==null?void 0:t.id}),g=z(()=>n.value?n.value.buyer_id===F.value?n.value.seller:n.value.buyer:null),J=t=>B(t).format("h:mm A"),Q=t=>{if(!t)return"";const s=B(t);return s.isSame(B(),"day")?"Today":s.isSame(B().subtract(1,"day"),"day")?"Yesterday":s.format("MMM D, YYYY")},A=()=>{he(()=>{$.value&&($.value.scrollTop=$.value.scrollHeight)})},W=()=>{h.value&&(h.value.style.height="auto",h.value.style.height=Math.min(h.value.scrollHeight,100)+"px")},ee=()=>{k.value=!k.value},se=()=>{var t;(t=g.value)!=null&&t.id&&x.push(`/user/${g.value.id}`)},te=async()=>{try{const t=await b.get(`/conversations/${d.params.uuid}`);n.value=t.data.data.conversation,v.value=t.data.data.messages.data||[],A()}catch{c.error("Failed to load chat"),x.push("/messages")}finally{j.value=!1}},S=async()=>{if(!m.value.trim()||p.value)return;p.value=!0;const t=m.value;m.value="",h.value&&(h.value.style.height="auto");try{const s=await b.post(`/conversations/${d.params.uuid}/messages`,{message:t,type:"text"});v.value.push(s.data.data),A()}catch{m.value=t,c.error("Failed to send")}finally{p.value=!1}},ae=async()=>{if(_.value){C.value=!1,p.value=!0;try{const t=await b.post(`/conversations/${d.params.uuid}/messages`,{message:`Offer: ₹${_.value}`,type:"offer",offer_amount:_.value});v.value.push(t.data.data),_.value="",A(),c.success("Offer sent")}catch{c.error("Failed to send offer")}finally{p.value=!1}}},T=async(t,s)=>{try{await b.post(`/messages/${t}/offer-response`,{action:s});const y=v.value.find(M=>M.id===t);y&&(y.offer_status=s==="accept"?"accepted":"rejected"),c.success(`Offer ${s}ed`)}catch{c.error("Failed")}},oe=async()=>{k.value=!1;try{await b.post(`/conversations/${d.params.uuid}/block`),c.success("Blocked"),x.push("/messages")}catch{c.error("Failed")}},le=async()=>{k.value=!1;try{await b.delete(`/conversations/${d.params.uuid}`),c.success("Deleted"),x.push("/messages")}catch{c.error("Failed")}};return de(te),(t,s)=>{var M,V,N,U,H,I,Y,Z,L;const y=ve("router-link");return o(),l("div",xe,[e("header",$e,[e("button",{onClick:s[0]||(s[0]=a=>t.$router.push("/messages")),class:"back-btn"},[f(w(ye),{class:"w-6 h-6"})]),n.value?(o(),l("div",{key:0,class:"user-info",onClick:se},[e("img",{src:((M=g.value)==null?void 0:M.avatar_url)||"/images/default-avatar.png",class:"avatar"},null,8,Me),e("div",Be,[e("h1",null,u((V=g.value)==null?void 0:V.name),1),s[8]||(s[8]=e("p",null,"Online",-1))])])):i("",!0),e("div",De,[(N=g.value)!=null&&N.phone?(o(),l("a",{key:0,href:`tel:${g.value.phone}`,class:"action-btn"},[f(w(ke),{class:"w-5 h-5"})],8,Fe)):i("",!0),e("button",{onClick:ee,class:"action-btn"},[f(w(be),{class:"w-5 h-5"})])])]),k.value?(o(),l("div",{key:0,class:"menu-overlay",onClick:s[2]||(s[2]=a=>k.value=!1)},[e("div",{class:"dropdown-menu",onClick:s[1]||(s[1]=P(()=>{},["stop"]))},[f(y,{to:`/listing/${(H=(U=n.value)==null?void 0:U.listing)==null?void 0:H.slug}`,class:"menu-item"},{default:O(()=>[...s[9]||(s[9]=[E("View Listing",-1)])]),_:1},8,["to"]),f(y,{to:`/user/${(I=g.value)==null?void 0:I.id}`,class:"menu-item"},{default:O(()=>[...s[10]||(s[10]=[E("View Profile",-1)])]),_:1},8,["to"]),e("button",{onClick:oe,class:"menu-item danger"},"Block User"),e("button",{onClick:le,class:"menu-item danger"},"Delete Chat")])])):i("",!0),(Y=n.value)!=null&&Y.listing?(o(),l("div",Ae,[f(y,{to:`/listing/${n.value.listing.slug}`,class:"product-link"},{default:O(()=>[e("img",{src:n.value.listing.primary_image_url,class:"product-img"},null,8,Oe),e("div",je,[e("p",Se,u(n.value.listing.title),1),e("p",Te,u(n.value.listing.formatted_price||"₹"+n.value.listing.price),1)]),f(w(fe),{class:"w-5 h-5 text-gray-400"})]),_:1},8,["to"])])):i("",!0),e("div",{ref_key:"messagesArea",ref:$,class:"messages-area"},[j.value?(o(),l("div",Ve,[...s[11]||(s[11]=[e("div",{class:"spinner"},null,-1)])])):(o(),l(R,{key:1},[v.value.length?(o(),l("div",Ne,u(Q((Z=v.value[0])==null?void 0:Z.created_at)),1)):i("",!0),(o(!0),l(R,null,pe(v.value,a=>{var K;return o(),l("div",{key:a.id,class:ge(["msg-row",a.sender_id===F.value?"sent":"received"])},[e("div",Ue,[a.type==="offer"?(o(),l("div",He,[s[12]||(s[12]=e("p",{class:"offer-label"},"Offer",-1)),e("p",Ie,"₹"+u((K=a.offer_amount)==null?void 0:K.toLocaleString()),1),a.offer_status==="pending"&&a.sender_id!==F.value?(o(),l("div",Ye,[e("button",{onClick:ne=>T(a.id,"accept"),class:"accept"},"Accept",8,Ze),e("button",{onClick:ne=>T(a.id,"reject"),class:"reject"},"Decline",8,Le)])):a.offer_status!=="pending"?(o(),l("p",Ke,u(a.offer_status==="accepted"?"Accepted":"Declined"),1)):i("",!0)])):i("",!0),e("p",ze,u(a.body),1),e("p",Ee,u(J(a.created_at)),1)])],2)}),128)),v.value.length?i("",!0):(o(),l("div",Pe,"No messages yet"))],64))],512),e("div",Re,[e("button",{onClick:s[3]||(s[3]=a=>C.value=!0),class:"offer-btn"},[f(w(we),{class:"w-6 h-6"})]),X(e("textarea",{ref_key:"inputField",ref:h,"onUpdate:modelValue":s[4]||(s[4]=a=>m.value=a),placeholder:"Type a message...",rows:"1",onInput:W,onKeydown:me(P(S,["exact","prevent"]),["enter"])},null,40,Xe),[[q,m.value]]),e("button",{onClick:S,disabled:!m.value.trim()||p.value,class:"send-btn"},[p.value?(o(),l("div",Ge)):(o(),_e(w(Ce),{key:1,class:"w-5 h-5"}))],8,qe)]),C.value?(o(),l("div",Je,[e("div",{class:"modal-bg",onClick:s[5]||(s[5]=a=>C.value=!1)}),e("div",Qe,[s[14]||(s[14]=e("h3",null,"Make an Offer",-1)),(L=n.value)!=null&&L.listing?(o(),l("div",We,[e("img",{src:n.value.listing.primary_image_url},null,8,es),e("div",null,[e("p",null,u(n.value.listing.title),1),e("p",ss,u(n.value.listing.formatted_price||"₹"+n.value.listing.price),1)])])):i("",!0),e("div",ts,[s[13]||(s[13]=e("span",null,"₹",-1)),X(e("input",{"onUpdate:modelValue":s[6]||(s[6]=a=>_.value=a),type:"number",placeholder:"Enter amount"},null,512),[[q,_.value]])]),e("div",as,[e("button",{onClick:s[7]||(s[7]=a=>C.value=!1),class:"cancel"},"Cancel"),e("button",{onClick:ae,disabled:!_.value,class:"submit"},"Send",8,os)])])])):i("",!0)])}}},ds=re(ls,[["__scopeId","data-v-b31d4960"]]);export{ds as default};
