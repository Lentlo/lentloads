var $=(C,v,_)=>new Promise((S,M)=>{var g=r=>{try{d(_.next(r))}catch(f){M(f)}},l=r=>{try{d(_.throw(r))}catch(f){M(f)}},d=r=>r.done?S(r.value):Promise.resolve(r.value).then(g,l);d((_=_.apply(C,v)).next())});import{k as n,l as o,p as e,q as ve,u as fe,f as p,b as j,o as pe,v as me,x as c,a as i,A as u,B as m,y as L,L as q,F as E,I as he,D as G,E as J,G as _e,z as Q,n as ge,H as W}from"./vue-vendor-Clry8SR-.js";import{_ as ke,d as ye,a as we,i as be,b as x}from"./main-capacitor-isrJZnKt.js";import{toast as h}from"./ui-vendor-B7DvqItC.js";import{d as O}from"./dayjs.min-BTXJx9iZ.js";import{r as $e}from"./ArrowLeftIcon-C2xikV9c.js";import{r as Ce}from"./PhoneIcon-BqlohvOv.js";import{r as xe}from"./EyeIcon-C--lcS42.js";import{r as Me}from"./UserIcon-Dxk9AEih.js";import{r as Ae}from"./TrashIcon-DHtKWE65.js";import{r as X}from"./CheckIcon-jEiSi5tZ.js";function ee(C,v){return o(),n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15 8.25H9m6 3H9m3 6-3-3h1.5a3 3 0 1 0 0-6M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})])}function Fe(C,v){return o(),n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z"})])}function Be(C,v){return o(),n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M18.364 18.364A9 9 0 0 0 5.636 5.636m12.728 12.728A9 9 0 0 1 5.636 5.636m12.728 12.728L5.636 5.636"})])}function De(C,v){return o(),n("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"})])}const Oe={class:"chat-page"},Se={class:"chat-header"},Ue={class:"header-content"},je={class:"avatar-ring"},Le=["src"],Te={class:"user-details"},Ve={class:"header-actions"},Ie=["href"],Ye={key:0,class:"product-strip"},He=["src"],Ze={class:"product-info"},ze={class:"product-name"},Ke={class:"product-price"},Ne={class:"product-arrow"},Pe={key:0,class:"loading"},Re={key:0,class:"date-chip"},qe={class:"msg-bubble"},Ee={key:0,class:"offer-content"},Ge={class:"offer-icon"},Je={class:"offer-amount"},Qe={key:0,class:"offer-actions"},We=["onClick"],Xe=["onClick"],es={class:"msg-text"},ss={class:"msg-meta"},ts={class:"msg-time"},as={key:0,class:"msg-status"},os={key:1,class:"empty-chat"},ns={class:"empty-icon"},ls={class:"input-area"},rs={class:"input-wrapper"},is=["onKeydown"],us=["disabled"],ds={key:0,class:"send-spinner"},cs={key:1,class:"modal-overlay"},vs={class:"modal-sheet"},fs={key:0,class:"modal-listing"},ps=["src"],ms={class:"listing-title"},hs={class:"listing-price"},_s={class:"offer-field"},gs={class:"modal-actions"},ks=["disabled"],ys={__name:"Conversation",setup(C){const v=ve(),_=fe(),S=ye(),M=p(!0),g=p(!1),l=p(null),d=p([]),r=p(""),f=p(!1),A=p(!1),y=p(""),F=p(null),w=p(null),B=j(()=>{var t;return(t=S.user)==null?void 0:t.id}),k=j(()=>l.value?l.value.buyer_id===B.value?l.value.seller:l.value.buyer:null),se=j(()=>{var s;const t=((s=k.value)==null?void 0:s.name)||"U";return`https://ui-avatars.com/api/?name=${encodeURIComponent(t)}&background=7c3aed&color=fff&size=100&bold=true`}),te=t=>O(t).format("h:mm A"),ae=t=>{if(!t)return"";const s=O(t);return s.isSame(O(),"day")?"Today":s.isSame(O().subtract(1,"day"),"day")?"Yesterday":s.format("MMM D, YYYY")},U=()=>{ge(()=>{F.value&&requestAnimationFrame(()=>{F.value.scrollTo({top:F.value.scrollHeight,behavior:"auto"})})})},oe=()=>{w.value&&(w.value.style.height="auto",w.value.style.height=Math.min(w.value.scrollHeight,100)+"px")},ne=()=>{f.value=!f.value},le=()=>{var t;(t=k.value)!=null&&t.id&&_.push(`/user/${k.value.id}`)},re=()=>$(this,null,function*(){try{const t=yield x.get(`/conversations/${v.params.uuid}`);l.value=t.data.data.conversation,d.value=t.data.data.messages.data||[],U()}catch(t){h.error("Failed to load chat"),_.push("/messages")}finally{M.value=!1}}),T=()=>$(this,null,function*(){if(!r.value.trim()||g.value)return;g.value=!0;const t=r.value;r.value="",w.value&&(w.value.style.height="auto");try{const s=yield x.post(`/conversations/${v.params.uuid}/messages`,{message:t,type:"text"});d.value.push(s.data.data),U()}catch(s){r.value=t,h.error("Failed to send")}finally{g.value=!1}}),ie=()=>$(this,null,function*(){if(y.value){A.value=!1,g.value=!0;try{const t=yield x.post(`/conversations/${v.params.uuid}/messages`,{message:`Offer: ₹${y.value}`,type:"offer",offer_amount:y.value});d.value.push(t.data.data),y.value="",U(),h.success("Offer sent")}catch(t){h.error("Failed to send offer")}finally{g.value=!1}}}),V=(t,s)=>$(this,null,function*(){try{yield x.post(`/messages/${t}/offer-response`,{action:s});const b=d.value.find(D=>D.id===t);b&&(b.offer_status=s==="accept"?"accepted":"rejected"),h.success(`Offer ${s}ed`)}catch(b){h.error("Failed")}}),ue=()=>$(this,null,function*(){f.value=!1;try{yield x.post(`/conversations/${v.params.uuid}/block`),h.success("User blocked"),_.push("/messages")}catch(t){h.error("Failed")}}),de=()=>$(this,null,function*(){f.value=!1;try{yield x.delete(`/conversations/${v.params.uuid}`),h.success("Chat deleted"),_.push("/messages")}catch(t){h.error("Failed")}});return pe(re),(t,s)=>{var D,I,Y,H,Z,z,K,N,P;const b=me("router-link");return o(),n("div",Oe,[e("header",Se,[s[10]||(s[10]=e("div",{class:"header-bg"},null,-1)),e("div",Ue,[e("button",{onClick:s[0]||(s[0]=a=>t.$router.push("/messages")),class:"back-btn"},[i(u($e),{class:"w-5 h-5"})]),l.value?(o(),n("div",{key:0,class:"user-section",onClick:le},[e("div",je,[e("img",{src:((D=k.value)==null?void 0:D.avatar_url)||se.value,class:"avatar"},null,8,Le),s[8]||(s[8]=e("span",{class:"online-indicator"},null,-1))]),e("div",Te,[e("h1",null,m((I=k.value)==null?void 0:I.name),1),s[9]||(s[9]=e("div",{class:"status"},[e("span",{class:"status-dot"}),e("span",null,"Active now")],-1))])])):c("",!0),e("div",Ve,[(Y=k.value)!=null&&Y.phone?(o(),n("a",{key:0,href:`tel:${k.value.phone}`,class:"header-btn phone"},[i(u(Ce),{class:"w-5 h-5"})],8,Ie)):c("",!0),e("button",{onClick:ne,class:"header-btn menu"},[i(u(Fe),{class:"w-5 h-5"})])])]),(H=l.value)!=null&&H.listing?(o(),n("div",Ye,[i(b,{to:`/listing/${l.value.listing.slug}`,class:"product-card"},{default:L(()=>[e("img",{src:l.value.listing.primary_image_url,class:"product-img"},null,8,He),e("div",Ze,[e("p",ze,m(l.value.listing.title),1),e("p",Ke,m(l.value.listing.formatted_price||"₹"+l.value.listing.price),1)]),e("div",Ne,[i(u(we),{class:"w-4 h-4"})])]),_:1},8,["to"])])):c("",!0)]),f.value?(o(),n("div",{key:0,class:"menu-overlay",onClick:s[2]||(s[2]=a=>f.value=!1)},[e("div",{class:"dropdown-menu",onClick:s[1]||(s[1]=q(()=>{},["stop"]))},[i(b,{to:`/listing/${(z=(Z=l.value)==null?void 0:Z.listing)==null?void 0:z.slug}`,class:"menu-item"},{default:L(()=>[i(u(xe),{class:"w-5 h-5"}),s[11]||(s[11]=e("span",null,"View Listing",-1))]),_:1},8,["to"]),i(b,{to:`/user/${(K=k.value)==null?void 0:K.id}`,class:"menu-item"},{default:L(()=>[i(u(Me),{class:"w-5 h-5"}),s[12]||(s[12]=e("span",null,"View Profile",-1))]),_:1},8,["to"]),e("button",{onClick:ue,class:"menu-item danger"},[i(u(Be),{class:"w-5 h-5"}),s[13]||(s[13]=e("span",null,"Block User",-1))]),e("button",{onClick:de,class:"menu-item danger"},[i(u(Ae),{class:"w-5 h-5"}),s[14]||(s[14]=e("span",null,"Delete Chat",-1))])])])):c("",!0),e("div",{ref_key:"messagesArea",ref:F,class:"messages-area"},[M.value?(o(),n("div",Pe,[...s[15]||(s[15]=[e("div",{class:"spinner"},null,-1),e("p",null,"Loading messages...",-1)])])):(o(),n(E,{key:1},[d.value.length?(o(),n("div",Re,[e("span",null,m(ae((N=d.value[0])==null?void 0:N.created_at)),1)])):c("",!0),(o(!0),n(E,null,he(d.value,a=>{var R;return o(),n("div",{key:a.id,class:W(["msg-wrapper",a.sender_id===B.value?"sent":"received"])},[e("div",qe,[a.type==="offer"?(o(),n("div",Ee,[e("div",Ge,[i(u(ee),{class:"w-5 h-5"})]),s[16]||(s[16]=e("p",{class:"offer-label"},"Price Offer",-1)),e("p",Je,"₹"+m((R=a.offer_amount)==null?void 0:R.toLocaleString()),1),a.offer_status==="pending"&&a.sender_id!==B.value?(o(),n("div",Qe,[e("button",{onClick:ce=>V(a.id,"accept"),class:"accept-btn"},"Accept",8,We),e("button",{onClick:ce=>V(a.id,"reject"),class:"decline-btn"},"Decline",8,Xe)])):a.offer_status!=="pending"?(o(),n("div",{key:1,class:W(["offer-badge",a.offer_status])},m(a.offer_status==="accepted"?"Accepted":"Declined"),3)):c("",!0)])):c("",!0),e("p",es,m(a.body),1),e("div",ss,[e("span",ts,m(te(a.created_at)),1),a.sender_id===B.value?(o(),n("span",as,[i(u(X),{class:"w-3.5 h-3.5"}),a.is_read?(o(),Q(u(X),{key:0,class:"w-3.5 h-3.5 -ml-1.5"})):c("",!0)])):c("",!0)])])],2)}),128)),d.value.length?c("",!0):(o(),n("div",os,[e("div",ns,[i(u(be),{class:"w-12 h-12"})]),s[17]||(s[17]=e("h3",null,"Start the conversation",-1)),s[18]||(s[18]=e("p",null,"Send a message or make an offer",-1))]))],64))],512),e("div",ls,[e("button",{onClick:s[3]||(s[3]=a=>A.value=!0),class:"offer-trigger"},[i(u(ee),{class:"w-6 h-6"})]),e("div",rs,[G(e("textarea",{ref_key:"inputField",ref:w,"onUpdate:modelValue":s[4]||(s[4]=a=>r.value=a),placeholder:"Type your message...",rows:"1",onInput:oe,onKeydown:_e(q(T,["exact","prevent"]),["enter"])},null,40,is),[[J,r.value]])]),e("button",{onClick:T,disabled:!r.value.trim()||g.value,class:"send-trigger"},[g.value?(o(),n("div",ds)):(o(),Q(u(De),{key:1,class:"w-5 h-5"}))],8,us)]),A.value?(o(),n("div",cs,[e("div",{class:"modal-backdrop",onClick:s[5]||(s[5]=a=>A.value=!1)}),e("div",vs,[s[20]||(s[20]=e("div",{class:"modal-handle"},null,-1)),s[21]||(s[21]=e("h3",null,"Make an Offer",-1)),(P=l.value)!=null&&P.listing?(o(),n("div",fs,[e("img",{src:l.value.listing.primary_image_url},null,8,ps),e("div",null,[e("p",ms,m(l.value.listing.title),1),e("p",hs,m(l.value.listing.formatted_price||"₹"+l.value.listing.price),1)])])):c("",!0),e("div",_s,[s[19]||(s[19]=e("span",{class:"currency"},"₹",-1)),G(e("input",{"onUpdate:modelValue":s[6]||(s[6]=a=>y.value=a),type:"number",placeholder:"Your offer"},null,512),[[J,y.value]])]),e("div",gs,[e("button",{onClick:s[7]||(s[7]=a=>A.value=!1),class:"btn-cancel"},"Cancel"),e("button",{onClick:ie,disabled:!y.value,class:"btn-submit"},"Send Offer",8,ks)])])])):c("",!0)])}}},Ss=ke(ys,[["__scopeId","data-v-9bad5831"]]);export{Ss as default};
